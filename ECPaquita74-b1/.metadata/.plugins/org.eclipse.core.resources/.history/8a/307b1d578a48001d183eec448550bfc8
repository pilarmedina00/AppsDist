package aadd.servlets;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.HashMap;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import aadd.beans.Actividad;

/**
 * Servlet implementation class ServletReservar
 */
@WebServlet(name = "ServletReservar", urlPatterns = { "/ServletReservar", "/reservar" })
public class ServletReservar extends HttpServlet {
	private static final long serialVersionUID = 1L;

	public ServletReservar() {
		super();
	}

	protected void doGet(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {

		response.setContentType("text/html");

		PrintWriter out = response.getWriter();
		// Obtenemos la ruta física al fichero del formulario

		String pathFichero = getServletConfig().getServletContext().getRealPath("reserva.html");

		BufferedReader br = new BufferedReader(new FileReader(pathFichero));

		String linea;
		while ((linea = br.readLine()) != null) {
			out.println(linea);
		}
		br.close();

		doPost(request, response);

	}

	protected void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {

		ServletContext app = getServletConfig().getServletContext();

		// Establecemos el tipo MIME de la respuesta
		response.setContentType("text/html");
		PrintWriter out = response.getWriter();

		// Intenta localizar la tabla de actividades
		HashMap<String, Actividad> actividadesHash = (HashMap<String, Actividad>) app.getAttribute("actividades");
		if (request.getParameter("codigo") != null) {
			String codigo = request.getParameter("codigo");
			boolean encontrada = false;
			if (actividadesHash != null) {
				for (Actividad actividad : actividadesHash.values()) {
					if (actividad.getIdActividad().equals(codigo)) {
						
						encontrada = true;
						
						if (actividad.getPlazas() > 0) {
							actividad.setPlazas(actividad.getPlazas() - 1);
							
							out.println("<html><head><h1>Reserva en la actividad completada</h1></head><body>");
							out.println("<h2>Has reservado una plaza en la actividad " + codigo + "</h2>");
							
						}
						else {
							out.println("<html><head><h1>Reserva en la actividad fallida</h1></head><body>");
							out.println("<h2>No quedan plazas disponibles en la actividad " + codigo + "</h2>");
						}
						
						break;
					}
				}
				if (!encontrada) {
					// Obtiene la URL precedente
					String referer = request.getHeader("referer");
					// Establece la cabecera de refresco
					response.setHeader("refresh", "5; URL=" + referer);
					
					out.println("<html><head><h1>Reserva en la actividad fallida</h1></head><body>");
					out.println("<html><head><h2>No existen actividades con el código " + codigo + "</h2></head><body>");
					out.println("<h2>Prueba de nuevo en unos segundos.</h2>");
				}
				
			}
		} else {
			HashMap<String, String> reservas = new HashMap<String, String>();
			for (Actividad actividad : actividadesHash.values()) {
				if () {
					reservas.put(actividad.getIdActividad(), actividad.getNombre());
				}
			}

		}
	}

}
